{% extends "base.html" %}

{% block content %}
    <div class="page-header">
        <div class="header-title">
            <h1>Семантический поиск</h1>
            {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
            <label class="checkbox-label">
                <input type="checkbox" id="show-all-applications" onchange="toggleApplicationsView()">
                <span>Показать все заявки</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="search-selected-applications" onchange="toggleMultiSelectMode()">
                <span>Поиск по выбранным заявкам</span>
            </label>
            {% endif %}
        </div>
    </div>
    <div class="search-container">
        <form id="search-form" method="post" class="search-form">
            <div class="form-group">
                <label for="application_id" id="application-label">Выберите заявку</label>
                <!-- Обычный select для режима одиночного выбора -->
                <select id="application_id" name="application_id" required>
                    <option value="">-- Выберите заявку --</option>
                    {% for app in applications %}
                        <option value="{{ app.id }}"
                                class="application-option"
                                data-owner-id="{{ app.user_id if app.user_id else '' }}"
                                {% if app.user_id != current_user.id %}style="display: none;"{% endif %}>
                            {{ app.name }} (ID: {{ app.id }})
                            {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
                                {% if app.user %}
                                    - {% if app.user.id == current_user.id %}Вы{% else %}{{ app.user.username }}{% endif %}
                                {% endif %}
                            {% endif %}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- Множественный выбор с чекбоксами -->
                <div id="applications-multiselect" class="multiselect-container" style="display: none;">
                    <div class="multiselect-header">
                        <span id="selected-count">Выбрано: 0</span>
                        <button type="button" class="btn-small" onclick="selectAllApplications()">Выбрать все</button>
                        <button type="button" class="btn-small" onclick="deselectAllApplications()">Снять все</button>
                    </div>
                    <div class="multiselect-list">
                        {% for app in applications %}
                        <label class="multiselect-option" 
                               data-owner-id="{{ app.user_id if app.user_id else '' }}"
                               {% if app.user_id != current_user.id %}style="display: none;"{% endif %}>
                            <input type="checkbox" 
                                   class="application-checkbox" 
                                   name="application_ids" 
                                   value="{{ app.id }}"
                                   onchange="updateSelectedCount()">
                            <span>
                                {{ app.name }} (ID: {{ app.id }})
                                {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
                                    {% if app.user %}
                                        - {% if app.user.id == current_user.id %}Вы{% else %}{{ app.user.username }}{% endif %}
                                    {% endif %}
                                {% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="query">Поисковый запрос</label>
                <input type="text" id="query" name="query" placeholder="Введите поисковый запрос..." required>
            </div>

            <h3>Настройки поиска</h3>

            <div class="form-row">
                <div class="form-group half-width">
                    <label for="search_limit">Количество результатов</label>
                    <select id="search_limit" name="search_limit">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                    <p class="form-note">Количество результатов поиска для отображения</p>
                </div>

                <div class="form-group half-width">
                    <div class="checkbox-item">
                        <input type="checkbox" id="use_reranker" name="use_reranker" value="true">
                        <label for="use_reranker">Использовать ререйтинг</label>
                    </div>
                    <p class="form-note">Ререйтинг улучшает качество результатов, но требует больше ресурсов</p>
                </div>
            </div>

            <div class="form-group rerank-limit-container" style="display: none;">
                <label for="rerank_limit">Количество документов для ререйтинга</label>
                <select id="rerank_limit" name="rerank_limit">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="9999">Все чанки в заявке</option>
                </select>
                <p class="form-note">Количество документов, извлекаемых для применения ререйтинга</p>
            </div>

            <!-- Добавляем настройки для умного/гибридного поиска -->
            <div class="form-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="use_smart_search" name="use_smart_search" value="true" checked>
                    <label for="use_smart_search">Использовать умный поиск</label>
                </div>
                <p class="form-note">Автоматически выбирает метод поиска в зависимости от длины запроса</p>
            </div>

            <div id="hybrid-settings" style="display: none;">
                <h3>Настройки гибридного поиска</h3>
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="vector_weight">Вес векторного поиска</label>
                        <input type="number" id="vector_weight" name="vector_weight" min="0" max="1" step="0.1" value="0.5">
                        <p class="form-note">Значение от 0.0 до 1.0, влияет на важность семантического поиска</p>
                    </div>
                    <div class="form-group half-width">
                        <label for="text_weight">Вес текстового поиска</label>
                        <input type="number" id="text_weight" name="text_weight" min="0" max="1" step="0.1" value="0.5">
                        <p class="form-note">Значение от 0.0 до 1.0, влияет на важность полнотекстового поиска</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hybrid_threshold">Порог для гибридного поиска</label>
                    <input type="number" id="hybrid_threshold" name="hybrid_threshold" min="1" max="100" value="50">
                    <p class="form-note">Длина запроса в символах, при которой используется гибридный поиск</p>
                </div>
            </div>

            <h3>Настройки LLM для обработки результатов (опционально)</h3>

            <div class="form-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="use_llm" name="use_llm" value="true">
                    <label for="use_llm">Обработать результаты через LLM</label>
                </div>
                <p class="form-note">Извлечение конкретного значения из результатов поиска с помощью LLM</p>
            </div>

            <div id="llm-settings" style="display: none;">
                <div class="form-group">
                    <label for="llm_model">Модель LLM</label>
                    <select id="llm_model" name="llm_model">
                        {% for model in available_models %}
                            <option value="{{ model }}" {% if model == default_llm_model %}selected{% endif %}>{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="llm_prompt_template">Промпт к LLM</label>
                    <textarea id="llm_prompt_template" name="llm_prompt_template" rows="10" placeholder="Введите промпт...">{{ default_prompt }}</textarea>
                    <p class="form-note">Используйте {query} для вставки поискового запроса и {context} для вставки контекста из найденных документов</p>
                </div>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="llm_temperature">Temperature</label>
                        <input type="number" id="llm_temperature" name="llm_temperature" step="0.1" min="0" max="1" value="0.1">
                        <p class="form-note">Значение от 0.0 до 1.0, влияет на креативность ответов</p>
                    </div>

                    <div class="form-group half-width">
                        <label for="llm_max_tokens">Max Tokens</label>
                        <input type="number" id="llm_max_tokens" name="llm_max_tokens" min="100" max="4000" value="1000">
                        <p class="form-note">Максимальная длина ответа в токенах</p>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="search-button" class="button">Выполнить поиск</button>
                <button type="button" id="stop-button" class="button button-danger" style="display: none;">Остановить поиск</button>
            </div>
        </form>

        <!-- Индикатор прогресса для поиска (БЕЗ СТАДИЙ) -->
        <div id="search-progress" class="search-progress" style="display: none;">
            <h3>Выполнение поиска</h3>
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>
            <p id="status-message">Выполняется поиск...</p>
        </div>

        <!-- Контейнер для результатов -->
        <div id="results-container" class="results-container" style="display: none;">
            <h2>Результаты поиска</h2>
            <div id="results-stats" class="results-stats"></div>

            <!-- Блок для отображения результата LLM -->
            <div id="llm-result" class="llm-result" style="display: none;">
                <h3>Извлеченное значение (LLM)</h3>
                <div class="info-card">
                    <div id="llm-value" class="llm-value"></div>
                    <div id="llm-confidence" class="confidence-container">
                        <p>Уверенность:</p>
                        <div class="confidence-bar">
                            <div id="confidence-value" class="confidence-value" style="width: 0%"></div>
                            <span id="confidence-text">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <h3>Найденные чанки</h3>
            <div id="search-results" class="search-results"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы для управления отображением настроек
            const useRerankerCheckbox = document.getElementById('use_reranker');
            const rerankLimitContainer = document.querySelector('.rerank-limit-container');
            const useLlmCheckbox = document.getElementById('use_llm');
            const llmSettings = document.getElementById('llm-settings');

            // Элементы для гибридного поиска
            const useSmartSearchCheckbox = document.getElementById('use_smart_search');
            const hybridSettings = document.getElementById('hybrid-settings');

            // Элементы формы и результатов
            const searchForm = document.getElementById('search-form');
            const resultsContainer = document.getElementById('results-container');
            const resultsStats = document.getElementById('results-stats');
            const searchResults = document.getElementById('search-results');
            const llmResult = document.getElementById('llm-result');
            const llmValue = document.getElementById('llm-value');
            const confidenceValue = document.getElementById('confidence-value');
            const confidenceText = document.getElementById('confidence-text');

            // Кнопки управления
            const searchButton = document.getElementById('search-button');
            const stopButton = document.getElementById('stop-button');

            // Переменные для отслеживания задачи
            let searchTracker = null;
            let currentTaskId = null;

            // Добавляем переменные для динамического обновления опции "Все чанки"
            const applicationSelect = document.getElementById('application_id');
            const rerankLimitSelect = document.getElementById('rerank_limit');
            const allChunksOption = rerankLimitSelect.querySelector('option[value="9999"]');

            // Функция для обновления текста опции "Все чанки"
            async function updateAllChunksOption() {
                const applicationId = applicationSelect.value;

                if (!applicationId || !allChunksOption) {
                    return;
                }

                try {
                    // Сохраняем исходный текст
                    allChunksOption.textContent = 'Все чанки в заявке (загрузка...)';

                    // Запрашиваем статистику
                    const response = await fetch(`/applications/${applicationId}/api/stats`);
                    if (response.ok) {
                        const data = await response.json();
                        const totalChunks = data.total_chunks || 0;
                        allChunksOption.textContent = `Все чанки в заявке (${totalChunks})`;
                    } else {
                        allChunksOption.textContent = 'Все чанки в заявке';
                    }
                } catch (error) {
                    console.error('Ошибка при получении количества чанков:', error);
                    allChunksOption.textContent = 'Все чанки в заявке';
                }
            }

            // Функция для обновления отображения настроек ререйтинга
            function updateRerankSettings() {
                if (useRerankerCheckbox.checked) {
                    rerankLimitContainer.style.display = 'block';
                    // Обновляем количество чанков при показе настроек
                    if (applicationSelect.value) {
                        updateAllChunksOption();
                    }
                } else {
                    rerankLimitContainer.style.display = 'none';
                }
            }

            // Функция для обновления отображения настроек LLM
            function updateLlmSettings() {
                if (useLlmCheckbox.checked) {
                    llmSettings.style.display = 'block';
                } else {
                    llmSettings.style.display = 'none';
                }
            }

            // Функция для обновления отображения настроек гибридного поиска
            function updateHybridSettings() {
                if (useSmartSearchCheckbox.checked) {
                    hybridSettings.style.display = 'block';
                } else {
                    hybridSettings.style.display = 'none';
                }
            }

            // Функция для отображения результатов
            function showResults(data) {
                // Скрываем прогресс
                document.getElementById('search-progress').style.display = 'none';

                // Показываем кнопку поиска, скрываем кнопку остановки
                searchButton.style.display = 'inline-block';
                stopButton.style.display = 'none';

                // Если поиск был отменен
                if (data.status === 'cancelled') {
                    resultsContainer.style.display = 'block';
                    resultsStats.innerHTML = '<p class="alert alert-warning">Поиск был остановлен пользователем.</p>';
                    searchResults.innerHTML = '';
                    return;
                }

                // Показываем результаты
                resultsContainer.style.display = 'block';

                // Отображаем статистику и информацию о методе поиска
                let searchMethodText = "";
                if (data.use_smart_search) {
                    if (data.search_method === "hybrid") {
                        searchMethodText = "Использован <strong>гибридный поиск</strong> (короткий запрос)";
                    } else {
                        searchMethodText = "Использован <strong>векторный поиск</strong> (длинный запрос)";
                    }
                } else if (data.use_reranker) {
                    searchMethodText = "Использован <strong>векторный поиск с ререйтингом</strong>";
                } else {
                    searchMethodText = "Использован <strong>векторный поиск</strong>";
                }

                let statsText;
                if (multiSelectMode && data.application_ids && data.application_ids.length > 1) {
                    const totalResults = data.count;
                    const perApp = Math.floor(totalResults / data.application_ids.length);
                    statsText = `Найдено результатов: <strong>${totalResults}</strong> (по ${perApp} на заявку из ${data.application_ids.length} заявок). ${searchMethodText}`;
                } else {
                    statsText = `Найдено результатов: <strong>${data.count}</strong>. ${searchMethodText}`;
                }

                resultsStats.innerHTML = `<p>${statsText}</p>`;
                if (data.execution_time) {
                    resultsStats.innerHTML += `<p>Время выполнения: <strong>${data.execution_time}</strong> сек.</p>`;
                }

                // Отображаем результат LLM, если есть
                if (data.llm_result) {
                    llmResult.style.display = 'block';
                    llmValue.textContent = data.llm_result.value;

                    // Устанавливаем индикатор уверенности
                    const confidence = data.llm_result.confidence * 100;
                    confidenceValue.style.width = `${confidence}%`;
                    confidenceText.textContent = `${Math.round(confidence)}%`;

                    // Меняем цвет индикатора в зависимости от уверенности
                    if (confidence > 75) {
                        confidenceValue.style.backgroundColor = '#28a745'; // зеленый
                    } else if (confidence > 50) {
                        confidenceValue.style.backgroundColor = '#ffc107'; // желтый
                    } else {
                        confidenceValue.style.backgroundColor = '#dc3545'; // красный
                    }
                } else {
                    llmResult.style.display = 'none';
                }

                // Очищаем предыдущие результаты
                searchResults.innerHTML = '';

                // Добавляем новые результаты
                if (data.results && data.results.length > 0) {
                    let currentAppId = null;
                    let appGroupDiv = null;
                    
                    data.results.forEach(result => {
                        // Проверяем, нужно ли создать новую группу для заявки (только в режиме множественного выбора)
                        if (multiSelectMode && result.application_id && result.application_id !== currentAppId) {
                            currentAppId = result.application_id;
                            
                            // Находим название заявки из списка
                            const appOption = document.querySelector(`.application-checkbox[value="${currentAppId}"]`);
                            let appFullName = '';
                            
                            if (appOption) {
                                const label = appOption.closest('label');
                                if (label) {
                                    const spanText = label.querySelector('span').textContent.trim();
                                    appFullName = spanText;
                                }
                            }
                            
                            // Если не нашли название, используем стандартный формат
                            if (!appFullName) {
                                appFullName = `Заявка ID: ${currentAppId}`;
                            }
                            
                            // Создаем заголовок для группы заявки
                            const appHeader = document.createElement('div');
                            appHeader.className = 'application-group-header';
                            appHeader.innerHTML = `<h3>${appFullName}</h3>`;
                            searchResults.appendChild(appHeader);
                            
                            // Создаем контейнер для результатов этой заявки
                            appGroupDiv = document.createElement('div');
                            appGroupDiv.className = 'application-group-results';
                            searchResults.appendChild(appGroupDiv);
                        }
                        
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';

                        // Подготавливаем информацию о релевантности и методе поиска
                        let scoreHtml = `<span class="result-score">Релевантность: ${result.score}</span>`;
                        let searchTypeDisplay = "";

                        if (result.search_type === "hybrid") {
                            searchTypeDisplay = `<span class="result-search-type result-hybrid">Гибридный поиск</span>`;
                        } else if (result.search_type === "text") {
                            searchTypeDisplay = `<span class="result-search-type result-text">Текстовый поиск</span>`;
                        } else {
                            searchTypeDisplay = `<span class="result-search-type result-vector">Векторный поиск</span>`;
                        }

                        if (data.use_reranker && result.rerank_score) {
                            scoreHtml = `
                                <span class="result-score-rerank">Релевантность (ререйтинг): ${result.rerank_score}</span>
                                <span class="result-score">Релевантность (векторная): ${result.score}</span>
                            `;
                        }

                        resultItem.innerHTML = `
                            <div class="result-header">
                                <span class="result-position">${result.position}</span>
                                <div class="result-meta">
                                    <span class="result-document">Фаил: ${result.document_name}</span>
                                    <span class="result-page">Страница: ${result.page_number || 'Не указана'}</span>
                                    ${searchTypeDisplay}
                                    ${scoreHtml}
                                </div>
                            </div>
                            <div class="result-content">${result.text}</div>
                        `;

                        // Добавляем в соответствующий контейнер
                        if (multiSelectMode && appGroupDiv) {
                            appGroupDiv.appendChild(resultItem);
                        } else {
                            searchResults.appendChild(resultItem);
                        }
                    });
                } else {
                    searchResults.innerHTML = '<p class="no-results">По вашему запросу ничего не найдено</p>';
                }
            }

            // Функция для обработки ошибки с восстановлением интерфейса
            function handleSearchError(error) {
                // Восстанавливаем кнопки
                searchButton.style.display = 'inline-block';
                stopButton.style.display = 'none';

                // Скрываем прогресс
                document.getElementById('search-progress').style.display = 'none';

                // Показываем ошибку
                resultsContainer.style.display = 'block';
                resultsStats.innerHTML = `<p class="alert alert-error">Ошибка при выполнении поиска: ${error.message || 'Неизвестная ошибка'}</p>`;
                searchResults.innerHTML = '';
            }

            // Обработчик кнопки остановки
            stopButton.addEventListener('click', function() {
                if (currentTaskId) {
                    // Отправляем запрос на остановку задачи
                    fetch(`/search/cancel/${currentTaskId}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Задача остановлена:', data);

                        // Останавливаем трекер
                        if (searchTracker) {
                            searchTracker._stopTracking();
                        }

                        // Показываем сообщение об отмене
                        showResults({
                            status: 'cancelled',
                            count: 0,
                            results: []
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка при остановке задачи:', error);
                        handleSearchError(error);
                    });
                }
            });

            // Обработчик отправки формы
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Сбрасываем предыдущий трекер
                if (searchTracker) {
                    searchTracker._stopTracking();
                }

                // Скрываем предыдущие результаты
                resultsContainer.style.display = 'none';
                llmResult.style.display = 'none';

                // Переключаем кнопки
                searchButton.style.display = 'none';
                stopButton.style.display = 'inline-block';

                // Формируем данные для отправки
                const formData = new FormData();
                
                // Добавляем все поля формы, кроме application_id и application_ids
                const tempForm = new FormData(searchForm);
                for (let [key, value] of tempForm.entries()) {
                    if (key !== 'application_id' && key !== 'application_ids') {
                        formData.append(key, value);
                    }
                }
                
                // Обрабатываем выбор заявок в зависимости от режима
                if (multiSelectMode) {
                    // Режим множественного выбора
                    const selectedCheckboxes = document.querySelectorAll('.application-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        alert('Пожалуйста, выберите хотя бы одну заявку');
                        searchButton.style.display = 'inline-block';
                        stopButton.style.display = 'none';
                        return;
                    }
                    
                    // Собираем ID выбранных заявок
                    const applicationIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                    formData.append('application_ids', applicationIds.join(','));
                    formData.append('multi_search', 'true');
                } else {
                    // Режим одиночного выбора
                    const applicationId = document.getElementById('application_id').value;
                    if (!applicationId) {
                        alert('Пожалуйста, выберите заявку');
                        searchButton.style.display = 'inline-block';
                        stopButton.style.display = 'none';
                        return;
                    }
                    formData.append('application_id', applicationId);
                }

                // Показываем прогресс-контейнер
                document.getElementById('search-progress').style.display = 'block';

                // Создаем новый трекер прогресса для поиска
                searchTracker = new TaskProgressTracker({
                    statusUrl: "/search/status",
                    progressBarId: "progress-bar",
                    statusMessageId: "status-message",
                    progressContainerId: "search-progress",
                    resultsContainerId: "results-container",
                    onComplete: showResults,
                    onError: handleSearchError,
                    checkInterval: 500
                });

                // Отправляем запрос на поиск
                fetch('/search/execute', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'pending') {
                        // Сохраняем ID задачи
                        currentTaskId = data.task_id;

                        // Получен ID задачи - начинаем отслеживать прогресс
                        console.log("Начинаем отслеживание задачи", data.task_id);
                        searchTracker.startTracking(data.task_id);
                    } else if (data.status === 'error') {
                        // Показываем ошибку
                        console.error("Ошибка запуска задачи:", data);
                        handleSearchError(data);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при запуске задачи поиска:', error);
                    handleSearchError({
                        message: `Ошибка при запуске задачи: ${error.message}`
                    });
                });
            });

            // Обновляем при смене заявки
            applicationSelect.addEventListener('change', updateAllChunksOption);

            // Инициализация и установка обработчиков событий
            updateRerankSettings();
            updateLlmSettings();
            updateHybridSettings();
            useRerankerCheckbox.addEventListener('change', updateRerankSettings);
            useLlmCheckbox.addEventListener('change', updateLlmSettings);
            useSmartSearchCheckbox.addEventListener('change', updateHybridSettings);
            // Текущий ID пользователя
            const currentUserId = {{ current_user.id }};
            
            // Переменная для отслеживания режима множественного выбора
            let multiSelectMode = false;

            // Функция переключения режима множественного выбора
            function toggleMultiSelectMode() {
                const checkbox = document.getElementById('search-selected-applications');
                const singleSelect = document.getElementById('application_id');
                const multiSelect = document.getElementById('applications-multiselect');
                const applicationLabel = document.getElementById('application-label');
                
                multiSelectMode = checkbox.checked;
                
                // Сохраняем состояние в localStorage с префиксом для страницы поиска
                localStorage.setItem('searchPage_multiSelectMode', multiSelectMode);
                
                if (multiSelectMode) {
                    // Переключаемся на множественный выбор
                    singleSelect.style.display = 'none';
                    singleSelect.removeAttribute('required');
                    multiSelect.style.display = 'block';
                    applicationLabel.textContent = 'Выберите заявки';
                    updateMultiSelectVisibility();
                } else {
                    // Возвращаемся к одиночному выбору
                    singleSelect.style.display = '';
                    singleSelect.setAttribute('required', 'required');
                    multiSelect.style.display = 'none';
                    applicationLabel.textContent = 'Выберите заявку';
                    // Снимаем все выделения
                    deselectAllApplications();
                }
            }
            
            // Функция обновления видимости опций в множественном выборе
            function updateMultiSelectVisibility() {
                const showAllCheckbox = document.getElementById('show-all-applications');
                const options = document.querySelectorAll('.multiselect-option');
                
                options.forEach(option => {
                    const ownerId = option.getAttribute('data-owner-id');
                    
                    if (showAllCheckbox && showAllCheckbox.checked) {
                        // Показать все заявки
                        option.style.display = '';
                    } else {
                        // Показать только свои заявки
                        if (ownerId && parseInt(ownerId) === currentUserId) {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    }
                });
            }
            
            // Функция выбора всех видимых заявок
            function selectAllApplications() {
                const checkboxes = document.querySelectorAll('.multiselect-option:not([style*="display: none"]) .application-checkbox');
                checkboxes.forEach(cb => cb.checked = true);
                updateSelectedCount();
            }
            
            // Функция снятия выделения со всех заявок
            function deselectAllApplications() {
                const checkboxes = document.querySelectorAll('.application-checkbox');
                checkboxes.forEach(cb => cb.checked = false);
                updateSelectedCount();
            }
            
            // Функция обновления счетчика выбранных заявок
            function updateSelectedCount() {
                const checkedBoxes = document.querySelectorAll('.application-checkbox:checked');
                const countElement = document.getElementById('selected-count');
                countElement.textContent = `Выбрано: ${checkedBoxes.length}`;
            }
            
            // Добавляем эти функции в глобальную область видимости
            window.toggleMultiSelectMode = toggleMultiSelectMode;
            window.selectAllApplications = selectAllApplications;
            window.deselectAllApplications = deselectAllApplications;
            window.updateSelectedCount = updateSelectedCount;

            // Функция переключения вида заявок
            function toggleApplicationsView() {
                const checkbox = document.getElementById('show-all-applications');
                const select = document.getElementById('application_id');
                const options = select.querySelectorAll('.application-option');

                // Сохраняем состояние в localStorage с префиксом для страницы поиска
                localStorage.setItem('searchPage_showAllApplications', checkbox.checked);

                // Сохраняем текущее выбранное значение
                const currentValue = select.value;
                let currentValueVisible = false;

                options.forEach(option => {
                    const ownerId = option.getAttribute('data-owner-id');

                    if (checkbox.checked) {
                        // Показать все заявки
                        option.style.display = '';
                        if (option.value === currentValue) {
                            currentValueVisible = true;
                        }
                        } else {
                            // Показать только свои заявки
                            if (ownerId && parseInt(ownerId) === currentUserId) {
                                option.style.display = '';
                            } else {
                                option.style.display = 'none';
                            }
                        }
                });

                // Если текущее выбранное значение скрыто, сбрасываем выбор
                if (!currentValueVisible && currentValue) {
                    select.value = '';
                    updateAllChunksOption(); // Обновляем опцию "Все чанки"
                }
                
                // Обновляем видимость в множественном выборе
                if (multiSelectMode) {
                    updateMultiSelectVisibility();
                }
            }
            window.toggleApplicationsView = toggleApplicationsView;

            // Восстанавливаем состояние чекбоксов из localStorage при загрузке страницы
            {% if current_user.is_admin() or current_user.is_prompt_engineer() %}
            // Восстанавливаем состояние "Показать все заявки"
            const savedShowAll = localStorage.getItem('searchPage_showAllApplications');
            if (savedShowAll !== null) {
                const showAllCheckbox = document.getElementById('show-all-applications');
                showAllCheckbox.checked = savedShowAll === 'true';
                toggleApplicationsView();
            } else {
                // По умолчанию скрываем чужие заявки
                toggleApplicationsView();
            }
            
            // Восстанавливаем состояние "Поиск по выбранным заявкам"
            const savedMultiSelect = localStorage.getItem('searchPage_multiSelectMode');
            if (savedMultiSelect !== null) {
                const multiSelectCheckbox = document.getElementById('search-selected-applications');
                multiSelectCheckbox.checked = savedMultiSelect === 'true';
                toggleMultiSelectMode();
            }
            {% endif %}
        });
    </script>

    <style>
        /* Стили для кнопки остановки */
        .button-danger {
            background-color: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background-color: #c82333;
        }

        /* Стили для уведомлений */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        /* Стили для результатов поиска */
        .llm-result {
            margin-bottom: 20px;
        }
        
        .info-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .llm-value {
            font-size: 1.1rem;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            margin-bottom: 15px;
            color: #212529;
        }

        .result-item {
            background-color: white;
            border: 1px solid #dee2e6;
            border-left: 3px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            transition: box-shadow 0.2s ease;
        }
        
        .result-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .result-header {
            display: flex;
            margin-bottom: 10px;
        }

        .result-position {
            font-size: 1rem;
            font-weight: bold;
            margin-right: 15px;
            background-color: #343a40;
            color: white;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .result-meta {
            display: flex;
            flex-direction: column;
        }

        .result-document, .result-page, .result-score, .result-score-rerank, .result-search-type {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .result-score-rerank {
            color: #28a745;
            font-weight: bold;
        }

        .result-search-type {
            font-weight: bold;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 5px;
        }

        .result-hybrid {
            background-color: #e6f3ff;
            color: #0066cc;
        }

        .result-text {
            background-color: #f0fff0;
            color: #006600;
        }

        .result-vector {
            background-color: #fff0f0;
            color: #cc0000;
        }

        .result-content {
            white-space: pre-line;
            font-family: monospace;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Стили для контейнера ошибок */
        .error-container {
            margin: 20px 0;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
        }

        .error-message {
            color: #721c24;
        }

        .error-message h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .error-message button {
            margin-top: 10px;
        }

        /* Стили для прогресс-бара поиска */
        .search-progress {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .progress {
            height: 20px;
            margin: 15px 0;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .progress-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #fff;
            text-align: center;
            background-color: #007bff;
            transition: width .6s ease;
        }

        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            from { background-position: 1rem 0 }
            to { background-position: 0 0 }
        }

        /* Стили для результатов поиска и статистики */
        .results-stats {
            background-color: #f8f9fa;
            border-left: 3px solid #28a745;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .results-stats p {
            margin: 5px 0;
            color: #495057;
        }
        
        .results-stats strong {
            color: #212529;
        }

        .no-results {
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 4px;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        /* Стиль для отображения уверенности */
        .confidence-container {
            margin-top: 10px;
        }
        
        .confidence-container p {
            margin: 0 0 8px 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .confidence-bar {
            position: relative;
            height: 22px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .confidence-value {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }

        .confidence-bar span {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            text-align: center;
            line-height: 22px;
            color: #212529;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 1;
        }

            /* Стили для page-header с чек-боксом */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .header-title h1 {
        margin: 0;
    }

    /* Стили для чекбокса */
    .checkbox-label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        user-select: none;
        margin: 0;
    }

    .checkbox-label input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
        width: 16px;
        height: 16px;
    }

    .checkbox-label span {
        color: #495057;
        white-space: nowrap;
        font-size: 14px;
        line-height: 1;
    }

    .checkbox-label:hover span {
        color: #007bff;
    }
    
    /* Стили для множественного выбора заявок */
    .multiselect-container {
        border: 1px solid #ced4da;
        border-radius: 6px;
        background-color: #fff;
        max-height: 350px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .multiselect-header {
        padding: 12px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .multiselect-header span {
        font-weight: 600;
        color: #495057;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 0.875rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .btn-small:hover {
        background-color: #0056b3;
    }
    
    .multiselect-list {
        max-height: 280px;
        overflow-y: auto;
        padding: 8px;
        background-color: #fff;
    }
    
    .multiselect-option {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-radius: 4px;
        margin-bottom: 3px;
        min-height: 40px;
    }
    
    .multiselect-option:hover {
        background-color: #f1f3f5;
    }
    
    .multiselect-option input[type="checkbox"] {
        margin-right: 12px;
        cursor: pointer;
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }
    
    .multiselect-option span {
        color: #495057;
        user-select: none;
        line-height: 1.4;
        flex-grow: 1;
    }
    
    .multiselect-option:has(input:checked) {
        background-color: #e7f1ff;
    }
    
    .multiselect-option:has(input:checked) span {
        font-weight: 500;
        color: #004085;
    }
    
    /* Стили для группировки результатов по заявкам */
    .application-group-header {
        background: linear-gradient(135deg, #0056b3 0%, #007bff 100%);
        color: white;
        padding: 14px 20px;
        margin-top: 20px;
        margin-bottom: 0;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .application-group-header:first-child {
        margin-top: 0;
    }
    
    .application-group-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: 0.3px;
    }
    
    .application-group-results {
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 15px;
        background-color: #f8f9fa;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .application-group-results .result-item {
        background-color: white;
        border: 1px solid #e9ecef;
        margin-bottom: 12px;
        transition: box-shadow 0.2s ease;
    }
    
    .application-group-results .result-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .application-group-results .result-item:last-child {
        margin-bottom: 0;
    }

    </style>
{% endblock %}